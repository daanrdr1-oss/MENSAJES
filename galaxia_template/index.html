<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Galaxia para ti</title>

  <!-- Meta / iconos -->
  <meta name="description" content="Galaxia interactiva de frases de cari침o 游눚">
  <meta property="og:title" content="Galaxia para ti">
  <meta property="og:description" content="Una galaxia interactiva con palabras de cari침o 游눘">
  <meta property="og:image" content="https://i.imghippo.com/files/dUaF4992bvo.png">
  <link rel="icon" type="image/png" href="https://i.imghippo.com/files/FpyF7764FFQ.png">

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden}
    #startBtn{display:block;transition:transform .18s cubic-bezier(.4,2,.6,1),box-shadow .18s;animation:pulseBtn 1.2s infinite cubic-bezier(.4,0,.6,1)}
    #startBtn:hover,#startBtn:focus{transform:scale(1.09);box-shadow:0 0 32px 8px #e7baff99,0 0 0 2px #fff2;outline:none}
    @keyframes pulseBtn{0%{transform:scale(1);box-shadow:0 0 0 0 #e7baff44}60%{transform:scale(1.13);box-shadow:0 0 32px 8px #e7baff99}100%{transform:scale(1);box-shadow:0 0 0 0 #e7baff44}}
    #galaxy-canvas{position:fixed;inset:0;width:100%;height:100%;display:block;touch-action:none}
    .attribution{position:fixed;left:10px;bottom:10px;font-size:11px;color:#b9a0ff;opacity:.8;background:rgba(0,0,0,.35);padding:6px 8px;border-radius:8px}
    .player{position:fixed;left:10px;right:10px;bottom:10px;display:flex;gap:8px;align-items:center;background:rgba(20,15,35,.35);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
    .player button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.08);color:#fff}
    .player input[type=file]{display:none}
    .pill{position:fixed;top:10px;left:50%;transform:translateX(-50%);padding:6px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;font:12px -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial}
    .error{position:fixed;inset:auto 10px 70px 10px;background:#260015;color:#ffd9f7;border:1px solid #ff8ae5;border-radius:10px;padding:10px;font:12px system-ui;display:none}
  </style>

  <!-- Three.js (principal) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
  <script>
    // Fallback si no carg칩 THREE desde jsDelivr
    if (!window.THREE) {
      var s=document.createElement('script');
      s.src="https://unpkg.com/three@0.128.0/build/three.min.js";
      document.head.appendChild(s);
    }
  </script>

  <!-- OrbitControls (principal) -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
    // Fallback de OrbitControls si hiciera falta
    if (!window.THREE || !THREE.OrbitControls) {
      var s=document.createElement('script');
      s.src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js";
      document.head.appendChild(s);
    }
  </script>
</head>
<body>

<!-- Modal de inicio -->
<div id="startModal" style="position:fixed;inset:0;z-index:1000;background:#000;display:flex;align-items:center;justify-content:center;flex-direction:column;">
  <button id="startBtn" style="background:none;border:none;outline:none;cursor:pointer;padding:0;">
    <img id="startImg" src="" alt="Iniciar" style="width:270px;height:270px;display:block;">
  </button>
</div>

<!-- M칰sica -->
<audio id="bgMusic" src="" preload="auto"></audio>

<canvas id="galaxy-canvas"></canvas>
<div id="err" class="error"></div>
<canvas id="fx" style="position:fixed;inset:0;pointer-events:none;"></canvas>

<script>
/* ======== CONFIG ======== */
const CONFIG = {
  AUDIO_URL: "https://www.dropbox.com/scl/fi/tr7h4uqednkeztfpa98u2/Lana-Del-Rey-Say-Yes-To-Heaven-Official-Audio.mp3?rlkey=rnindbpwsx24kclg8zwbr5aow&st=cq5t3xa8&dl=1",
  BTN_IMAGE: "https://i.imghippo.com/files/kRka2102tac.jpg",
  OVERLAY_IMAGE: "https://i.imghippo.com/files/UIp9296LUY.jpg",
  RING_IMAGES: [
    "https://i.imghippo.com/files/iX9460ek.jpg",
    "https://i.imghippo.com/files/ZE6755A.jpg",
    "https://i.imghippo.com/files/SeG3264jB.jpg",
    "https://i.imghippo.com/files/phQh8301qno.jpg"
  ],
  PHRASES: ["My Sun","My Universe","I adore you","I love you","My home","My Angel","Kitty","My Princess"]
};
/* ====== FIN CONFIG ====== */

document.addEventListener('DOMContentLoaded', function() {
  // aplica URLs de la CONFIG
  document.getElementById('startImg').src = CONFIG.BTN_IMAGE;
  document.getElementById('bgMusic').src = CONFIG.AUDIO_URL;

  const modal = document.getElementById('startModal');
  const btn = document.getElementById('startBtn');
  const music = document.getElementById('bgMusic');

  btn.addEventListener('click', function() {
    modal.style.display = 'none';
    music.volume = 0.7;
    music.currentTime = 0;
    music.play().catch(()=>{});
    // Espera a que THREE est칠 disponible en caso de fallback
    (function waitForThree(){
      if (window.THREE && THREE.OrbitControls) runGalaxy({ cinematic: true });
      else setTimeout(waitForThree, 50);
    })();
  });

  function runGalaxy(opts={}) {
    const err = document.getElementById('err');
    function showError(msg){ err.textContent = msg; err.style.display='block'; }

    // WEBGL CHECK
    try {
      const test = document.createElement('canvas').getContext('webgl') || document.createElement('canvas').getContext('experimental-webgl');
      if(!test) throw new Error('Tu navegador no tiene WebGL activo');
    } catch(e) { showError('WebGL parece desactivado. Prueba con Chrome/Edge/Firefox, o habilita aceleraci칩n por hardware.'); return; }

    try {
      // Setup
      const canvas = document.getElementById('galaxy-canvas');
      const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:false });
      renderer.setPixelRatio(Math.min(2, window.devicePixelRatio||1));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputEncoding = THREE.sRGBEncoding;

      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true; controls.dampingFactor = 0.06;
      controls.minDistance = 10; controls.maxDistance = 220;
      controls.target.set(0,0,0);

      // Cinem치tica
      let cinematicState = opts.cinematic ? 0 : null;
      let cinematicStart = null;
      const d1=2.2, d2=3.5, d3=2.2, dTot=d1+d2+d3;

      function setCam(){
        const w = window.innerWidth, h = window.innerHeight;
        const isMobile = w < 768 || w < h;
        camera.fov = isMobile ? 90 : 75;
        camera.position.set(0, isMobile? 26 : 22, isMobile? 110 : 75);
        camera.updateProjectionMatrix(); controls.update();
      }
      setCam();
      renderer.setClearColor(0x000000, 1);

      // Explosiones
      const explosions = [];
      function spawnExplosion() {
        const geo = new THREE.PlaneGeometry(60, 60);
        const c = document.createElement('canvas'); c.width = c.height = 256;
        const g = c.getContext('2d');
        const grad = g.createRadialGradient(128,128,10,128,128,128);
        grad.addColorStop(0,'rgba(255,255,200,0.85)');
        grad.addColorStop(0.2,'rgba(255,220,120,0.45)');
        grad.addColorStop(0.5,'rgba(255,180,255,0.18)');
        grad.addColorStop(1,'rgba(0,0,0,0)');
        g.fillStyle = grad; g.fillRect(0,0,256,256);
        const tex = new THREE.CanvasTexture(c);
        const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, depthWrite: false, blending: THREE.AdditiveBlending });
        const mesh = new THREE.Mesh(geo, mat);
        const angle = Math.random()*Math.PI*2;
        const dist = 70 + Math.random()*60;
        mesh.position.set(Math.cos(angle)*dist, (Math.random()-0.5)*40, Math.sin(angle)*dist);
        mesh.lookAt(0,0,0);
        mesh.material.opacity = 0.85;
        mesh.userData.life = 1.0;
        explosions.push(mesh);
        scene.add(mesh);
      }
      setInterval(()=>{ if(Math.random()<0.85) spawnExplosion(); }, 700);

      // Utilidades de textura
      function makeTextTexture(text, size=48){
        const c=document.createElement('canvas'); c.width=1024; c.height=128;
        const g=c.getContext('2d'); g.clearRect(0,0,c.width,c.height);
        g.font='800 '+size+'px -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial';
        g.textAlign='center'; g.textBaseline='middle';
        g.shadowColor='rgba(210,140,255,0.95)'; g.shadowBlur=24;
        g.fillStyle='rgba(255,240,255,0.98)'; g.fillText(text,c.width/2,c.height/2);
        return new THREE.CanvasTexture(c);
      }
      function makeImageTexture(url, cb) {
        const img = new Image(); img.crossOrigin = "anonymous";
        img.onload = function() {
          const c = document.createElement('canvas'); c.width = c.height = 256;
          const g = c.getContext('2d'); g.clearRect(0,0,256,256);
          g.filter = 'contrast(1.25) saturate(1.25)';
          g.drawImage(img, 0, 0, 256, 256);
          g.filter = 'none';
          cb(new THREE.CanvasTexture(c));
        };
        img.onerror = ()=>cb(null);
        img.src = url;
      }

      // Galaxia: frases + im치genes
      const galaxy = new THREE.Group(); scene.add(galaxy);
      const phrases = CONFIG.PHRASES;
      const ringImgs = CONFIG.RING_IMAGES;

      const phraseCount = Math.max(phrases.length * 8, 240);
      const arms = 5, radius = 82, maxH = 22;
      const totalSprites = phraseCount;
      const imgCount = Math.floor(totalSprites * 0.35);
      let imgPointer = 0;

      for(let i=0;i<totalSprites;i++){
        const perArm=totalSprites/arms; const ang=(i%perArm)*(Math.PI*2/perArm);
        const armAng=Math.floor(i/perArm)*(Math.PI*2/arms);
        const minDist = radius * 1.18, maxDist = radius * 1.38;
        const dist = minDist + (maxDist - minDist) * (i/totalSprites);
        const thickness=Math.pow(1-(dist/(radius*1.38)),2);
        const x=Math.cos(ang+armAng)*dist, z=Math.sin(ang+armAng)*dist, y=(Math.random()-0.5)*maxH*thickness*.9;
        const isTop = y > (maxH*0.7), isBottom = y < -(maxH*0.7);

        if (ringImgs.length && (i<imgCount || isTop || isBottom)) {
          const imgUrl = ringImgs[imgPointer % ringImgs.length];
          makeImageTexture(imgUrl, function(tex){
            if(!tex) return;
            const spr = new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, color: 0xffffff, transparent: true, depthWrite: false }));
            spr.position.set(x, y + 10, z); spr.scale.set(8, 8, 1); galaxy.add(spr);
          });
          imgPointer++;
        } else {
          const text = phrases[i%phrases.length];
          const tex=makeTextTexture(text,48);
          const spr=new THREE.Sprite(new THREE.SpriteMaterial({ map:tex, transparent:true, depthWrite:false }));
          spr.position.set(x,y,z); spr.scale.set(20,2.6,1); galaxy.add(spr);
        }
      }

      // Estrellas
      const starCount=8000, geom=new THREE.BufferGeometry(), pos=new Float32Array(starCount*3);
      for(let i=0;i<starCount;i++){ const ang=Math.random()*Math.PI*2, dist=Math.random()*radius*1.15;
        const y=(Math.random()-0.5)*36*Math.pow(1-Math.min(dist,radius)/radius,1.5);
        pos[i*3]=Math.cos(ang)*dist; pos[i*3+1]=y; pos[i*3+2]=Math.sin(ang)*dist; }
      geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
      galaxy.add(new THREE.Points(geom, new THREE.PointsMaterial({ color:0xffffff, size:0.28, transparent:true, opacity:0.65, blending:THREE.AdditiveBlending })));

      // N칰cleo y luz
      const coreR = 12;
      const coreTexCanvas = document.createElement('canvas'); coreTexCanvas.width = coreTexCanvas.height = 256;
      const cg = coreTexCanvas.getContext('2d');
      const grd = cg.createRadialGradient(128,128,10,128,128,128);
      grd.addColorStop(0, '#3a7cff'); grd.addColorStop(0.5, '#0a2a6b'); grd.addColorStop(1, '#000a2a');
      cg.fillStyle = grd; cg.arc(128,128,128,0,Math.PI*2); cg.fill();
      const core = new THREE.Mesh(new THREE.SphereGeometry(coreR,64,64), new THREE.MeshPhongMaterial({ map:new THREE.CanvasTexture(coreTexCanvas), shininess:60, specular:0x7ecbff }));
      core.renderOrder = 1; scene.add(core);
      const light = new THREE.PointLight(0x7ecbff, 1.2, 200); light.position.set(0,30,60); scene.add(light);

      // Imagen flotante opcional
      let imgMesh = null;
      if (CONFIG.OVERLAY_IMAGE){
        new THREE.TextureLoader().load(CONFIG.OVERLAY_IMAGE, function(tex) {
          const imgSize = coreR * 1.7;
          imgMesh = new THREE.Mesh(new THREE.PlaneGeometry(imgSize, imgSize), new THREE.MeshBasicMaterial({ map: tex, transparent: true }));
          imgMesh.position.set(0, coreR * 2.1, 0); imgMesh.renderOrder = 2; scene.add(imgMesh);
        });
      }

      // Halo y anillo
      const photonRing=new THREE.Mesh(new THREE.RingGeometry(coreR*1.05, coreR*1.18, 128), new THREE.MeshBasicMaterial({ color:0xEAAEFF, transparent:true, opacity:0.95, side:THREE.DoubleSide }));
      photonRing.rotation.x=-Math.PI/2; photonRing.renderOrder=0.5; scene.add(photonRing);

      // Animaci칩n
      function animate(){
        requestAnimationFrame(animate);
        const t = performance.now()*0.001;

        if (cinematicState !== null) {
          if (cinematicStart === null) cinematicStart = t;
          const e = t - cinematicStart;
          if (e < d1) {
            const p = e/d1;
            camera.position.lerpVectors(new THREE.Vector3(0,0,220), new THREE.Vector3(0,18,38), p);
            camera.lookAt(0,0,0); controls.enabled=false;
          } else if (e < d1 + d2) {
            const p=(e-d1)/d2, ang = Math.PI/2 + p * Math.PI * 2 * 0.85, r=38, y=18;
            camera.position.set(Math.cos(ang)*r, y, Math.sin(ang)*r);
            camera.lookAt(0,0,0); controls.enabled=false;
          } else if (e < dTot) {
            const p=(e-d1-d2)/d3, a0=Math.PI/2 + Math.PI * 2 * 0.85, r0=38, r1=220, y0=18, y1=80;
            camera.position.set(Math.cos(a0)*(r0+(r1-r0)*p), y0+(y1-y0)*p, Math.sin(a0)*(r0+(r1-r0)*p));
            camera.lookAt(0,0,0); controls.enabled=false;
          } else { controls.enabled=true; cinematicState=null; }
        }

        core.rotation.y = t * 0.12;
        photonRing.rotation.z = t * 0.18;
        haloPlane.rotation.z = t * 0.02;
        if(imgMesh) imgMesh.lookAt(camera.position);

        for(let i=explosions.length-1;i>=0;i--){
          const e = explosions[i]; e.material.opacity *= 0.94; e.userData.life -= 0.018;
          if(e.userData.life<=0.05){ scene.remove(e); explosions.splice(i,1); }
        }

        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // FX corazones
      const fx = document.getElementById('fx'); const ctx2 = fx.getContext('2d');
      function resizeFx(){
        fx.width = Math.floor(innerWidth * Math.min(2, window.devicePixelRatio||1));
        fx.height = Math.floor(innerHeight * Math.min(2, window.devicePixelRatio||1));
        fx.style.width = innerWidth + 'px'; fx.style.height = innerHeight + 'px';
      }
      addEventListener('resize', resizeFx); resizeFx();
      const DPR = Math.min(2, window.devicePixelRatio || 1);
      const hearts = [];
      function spawnHearts(x,y,n=20){
        x *= DPR; y *= DPR;
        for(let i=0;i<n;i++){ const a=Math.random()*Math.PI*2;
          hearts.push({x,y,vx:Math.cos(a)*(0.6+Math.random()*0.8),vy:-(0.8+Math.random()*1.2),life:1,size:10+Math.random()*16});
        }
      }
      function drawHeart(x,y,size){
        const s=size; ctx2.save(); ctx2.translate(x,y);
        ctx2.beginPath(); ctx2.moveTo(0,-0.25*s);
        ctx2.bezierCurveTo(.5*s,-.9*s,1.4*s,-.1*s,0,.9*s);
        ctx2.bezierCurveTo(-1.4*s,-.1*s,-.5*s,-.9*s,0,-.25*s);
        const g=ctx2.createRadialGradient(0,0,0,0,0,s);
        g.addColorStop(0,'rgba(255,190,220,.95)'); g.addColorStop(1,'rgba(255,90,160,0)');
        ctx2.fillStyle=g; ctx2.fill(); ctx2.restore();
      }
      let lastTap=0;
      addEventListener('click', (e)=>{ const now=performance.now(); if(now-lastTap<320) spawnHearts(e.clientX,e.clientY,20); lastTap=now; }, {passive:true});
      addEventListener('touchend', (e)=>{ const now=performance.now(); const t=e.changedTouches&&e.changedTouches[0]; if(now-lastTap<320&&t) spawnHearts(t.clientX,t.clientY,20); lastTap=now; }, {passive:true});
      (function loopFx(){
        ctx2.clearRect(0,0,fx.width,fx.height);
        for(let i=hearts.length-1;i>=0;i--){ const h=hearts[i]; h.x+=h.vx; h.y+=h.vy; h.vy-=0.02; h.life-=0.015;
          ctx2.globalAlpha=Math.max(0,h.life); drawHeart(h.x,h.y,h.size); ctx2.globalAlpha=1; if(h.life<=0) hearts.splice(i,1);
        }
        requestAnimationFrame(loopFx);
      })();

    } catch(e) { showError('Error cargando la galaxia: '+e.message); console.error(e); }
  }
});
</script>
</body>
</html>
